<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="猥琐发育，别浪"><meta name="keywords" content="android"><title>热更新 | MVP</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">热更新</h1><a id="logo" href="/.">MVP</a><p class="description">猥琐发育，别浪</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 主页</i></a><a href="/archives/"><i class="fa fa-archive"> 文章</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">热更新</h1><div class="post-meta"><a href="/2018/06/04/热修复/#comments" class="comment-count"></a><p><span class="date">Jun 04, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Schlägt</i></i></span></p></div><div class="post-content"><p>热更新现在在国内已经相当普及了，主要用于修复突发严重bug，避免了重新打包App、测试、向各个应用市场和渠道换包、提示用户升级、用户下载、覆盖安装到巨大的成本</p>
<h2 id="热更新作用"><a href="#热更新作用" class="headerlink" title="热更新作用"></a>热更新作用</h2><ul>
<li>无需重新发版，简单高效</li>
<li>用户无感知，无需下载新应用，代价小</li>
<li>修复成功率高，挽回用户群体<h2 id="主流"><a href="#主流" class="headerlink" title="主流"></a>主流</h2></li>
<li>Native<ul>
<li>Dexposed(阿里)</li>
<li>AndFix(阿里)</li>
</ul>
</li>
<li>Java:<ul>
<li>Tinker(微信)</li>
<li>Qzone(QQ空间)</li>
<li>nuwa(大众点评)</li>
<li>robust(美团)</li>
</ul>
</li>
</ul>
<p><img src="http://mmbiz.qpic.cn/mmbiz/csvJ6rH9Mct2S79NW7Qy83cyABDn0BN825x4bbEZmfhbiavSI2VibLabiaPMSnktQDcA5OEqgnZPPPUX6gl5mIQ1g/0?wx_fmt=png" alt=""></p>
<h2 id="AndFix原理"><a href="#AndFix原理" class="headerlink" title="AndFix原理"></a>AndFix原理</h2><h3 id="修复流程"><a href="#修复流程" class="headerlink" title="修复流程"></a>修复流程</h3><p><img src="https://images2015.cnblogs.com/blog/895082/201609/895082-20160912092045539-1653829774.png" alt="image"></p>
<p>直接在native层进行方法的结构体信息对换，从而实现完美的方法新旧替换，从而实现热修复功能</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2241150-e43a1db5d19defc4?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt=""></p>
<p><img src="https://img-blog.csdn.net/20151113112729932" alt=""></p>
<h3 id="优势："><a href="#优势：" class="headerlink" title="优势："></a>优势：</h3><ul>
<li>BUG修复的即时性</li>
<li>补丁包同样采用差量技术，生成的PATCH体积小</li>
<li>对应用无侵入，几乎无性能损耗</li>
</ul>
<h3 id="不足："><a href="#不足：" class="headerlink" title="不足："></a>不足：</h3><ul>
<li>不支持新增字段，以及修改<init>方法，也不支持对资源的替换。</init></li>
<li>由于厂商的自定义ROM，对少数机型暂不支持。</li>
</ul>
<h2 id="Qzone原理"><a href="#Qzone原理" class="headerlink" title="Qzone原理"></a>Qzone原理</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>超级补丁技术基于DEX分包方案，使用了多DEX加载的原理，大致的过程就是：把BUG方法修复以后，放到一个单独的DEX里，插入到dexElements数组的最前面，让虚拟机去加载修复完后的方法。</p>
<p><img src="https://images2015.cnblogs.com/blog/895082/201609/895082-20160912091621883-434452861.png" alt=""></p>
<p>DEX分包的实现涉及到虚拟机的类加载</p>
<h3 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h3><p><img src="http://mmbiz.qpic.cn/mmbiz/0aYRVN1mAJwR6vqR4Yv6V3zIvjqmgdu75fv55IpLkDqm2MibiaVQNFMQ3xFNk9ez1CXPibFPn0ibiboQf2kWPfSL8Mg/640" alt=""></p>
<p>ClassLoader加载dex文件，每个dex文件是一个Element，多个dex文件排列成一个有序的数组dexElements，当找类的时候，会按顺序遍历dex文件，然后从当前遍历的dex文件中找类，如果找类则返回，如果找不到从下一个dex文件继续查找。<br>理论上，如果在不同的dex中有相同的类存在，那么会优先选择排在前面的dex文件的类，如下图：</p>
<p><img src="http://mmbiz.qpic.cn/mmbiz/0aYRVN1mAJwR6vqR4Yv6V3zIvjqmgdu7dVfrXN7XxhOjiaahHricl00hal4rjw1cQ2LRFKVGU7uUOO0Q5HSz7hKw/640" alt=""></p>
<p><img src="http://mmbiz.qpic.cn/mmbiz/0aYRVN1mAJwR6vqR4Yv6V3zIvjqmgdu7L1OTRicUdpKy3Txd5eancPZXSWKVic4S9A7rUticj9aKY5UhfbAhjpLjg/640" alt=""></p>
<h3 id="引发问题"><a href="#引发问题" class="headerlink" title="引发问题"></a>引发问题</h3><p>在APK安装的时候，虚拟机会将DEX优化成ODEX后才拿去执行。在这个过程中会对所有CLASS一个校验.假设A该类在它的STATIC方法，PRIVATE方法，构造函数，OVERRIDE方法中直接引用到B类。如果A类和B类在同一个DEX中，那么A类就会被打上CLASS_ISPREVERIFIED标记,被打上这个标记的类不能引用其他DEX中的类,否则会报错.而普通分包方案则不会出现这个错误，因为引用和被引用的两个类一开始就不在同一个DEX中，所以校验的时候并不会被打上CLASS_ISPREVERIFIED</p>
<h3 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h3><p>A类如果还引用了一个C类，而C类在其他dex中，那么A类并不会被打上标记。换句话说，只要在static方法，构造方法，private方法，override方法中直接引用了其他dex中的类，那么这个类就不会被打上CLASS_ISPREVERIFIED标记。</p>
<p><img src="https://img-blog.csdn.net/20160317145346556" alt=""></p>
<h3 id="修复流程-1"><a href="#修复流程-1" class="headerlink" title="修复流程"></a>修复流程</h3><ul>
<li>可以看出是通过获取到当前应用的Classloader，即为BaseDexClassloader</li>
<li>通过反射获取到他的DexPathList属性对象pathList</li>
<li>通过反射调用pathList的dexElements方法把patch.dex转化为Element[]</li>
<li>两个Element[]进行合并，把patch.dex放到最前面去</li>
<li>加载Element[]，达到修复目的</li>
</ul>
<p><img src="https://images2015.cnblogs.com/blog/895082/201609/895082-20160912091840555-541505502.png" alt="image"></p>
<h2 id="Tinker原理"><a href="#Tinker原理" class="headerlink" title="Tinker原理"></a>Tinker原理</h2><h3 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h3><p>主要的原理是与QQ空间超级补丁技术基本相同，区别在于不再将patch.dex增加到elements数组中，而是差量的方式给出patch.dex，然后将patch.dex与应用的classes.dex合并，然后整体替换掉旧的DEX文件，以达到修复的目的。</p>
<p><img src="https://images2015.cnblogs.com/blog/895082/201609/895082-20160912091909227-324812344.png" alt="image"></p>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p><img src="https://images2015.cnblogs.com/blog/895082/201609/895082-20160912092000133-1248305667.png" alt="image"></p>
<p>引用：</p>
<p><a href="http://www.cnblogs.com/alibaichuan/p/5863616.html" target="_blank" rel="noopener">http://www.cnblogs.com/alibaichuan/p/5863616.html</a><br><a href="https://www.jianshu.com/p/e3f1fc082b05" target="_blank" rel="noopener">https://www.jianshu.com/p/e3f1fc082b05</a></p>
</div><div class="tags"></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2018/05/06/排序算法与插入排序/" class="next">选择排序与插入排序</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Inhalte</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#热更新作用"><span class="toc-text">热更新作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#主流"><span class="toc-text">主流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AndFix原理"><span class="toc-text">AndFix原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#修复流程"><span class="toc-text">修复流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优势："><span class="toc-text">优势：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不足："><span class="toc-text">不足：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Qzone原理"><span class="toc-text">Qzone原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原理"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#类加载"><span class="toc-text">类加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引发问题"><span class="toc-text">引发问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决问题"><span class="toc-text">解决问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修复流程-1"><span class="toc-text">修复流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tinker原理"><span class="toc-text">Tinker原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原理："><span class="toc-text">原理：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流程图"><span class="toc-text">流程图</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/04/热修复/">热更新</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/06/排序算法与插入排序/">选择排序与插入排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/06/Android Studio 进阶（二） ：结构化搜索跟替换/">Android Studio 进阶（二） ：结构化搜索跟替换</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/21/hello-world/">Android Studio 进阶（一） ：快捷键</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archiv</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">RSS</a> |  <a href="/about/">Über</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">MVP.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>